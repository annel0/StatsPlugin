# name: Демонстрация GitHub CI/CD с автоматическим созданием тега и релиза
on:
  push:
    branches:
      - main  # Запускать workflow при пуше в ветку main

jobs:
  build-test:
    runs-on: ubuntu-latest

    env:
      RUNNER_DEBUG: 1

    steps:
      - name: Клонирование репозитория
        uses: actions/checkout@v3  # Используем v3 для GitHub

      - name: Установка JDK
        uses: actions/setup-java@v3  # Используем v3 для GitHub
        with:
          java-version: "21"
          distribution: 'temurin'

      - name: Сборка проекта
        run: ./gradlew build

      - name: Проверка выходных файлов
        run: ls -la build/libs

      - name: Создание тега через GitHub API
        env:
          API_URL: "https://api.github.com"
          REPO: ${{ github.repository }}
          COMMIT_SHA: ${{ github.sha }}
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # Формируем имя тега
          TAG_NAME="v$(date +%Y.%m.%d)-${GITHUB_RUN_NUMBER}"
          
          # Создаем объект тега
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $PERSONAL_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL/repos/$REPO/git/tags" \
            -d '{
              "tag": "'"$TAG_NAME"'",
              "message": "Автоматически созданный тег",
              "object": "'"$COMMIT_SHA"'",
              "type": "commit",
              "tagger": {
                "name": "GitHub Actions",
                "email": "action@github.com",
                "date": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }
            }'
          
          # Создаем ссылку на тег
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $PERSONAL_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL/repos/$REPO/git/refs" \
            -d '{
              "ref": "refs/tags/'"$TAG_NAME"'",
              "sha": "'"$COMMIT_SHA"'"
            }'
          
      - name: Создание релиза и загрузка JAR-файла
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1  # Используем действие для создания релиза
        with:
          files: build/libs/*.jar  # Загружаем JAR-файл напрямую
          body: "Автоматически созданный релиз из GitHub Actions"
          token: ${{ secrets.GITHUB_TOKEN }}  # Токен для авторизации
