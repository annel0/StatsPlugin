# name: Демонстрация GitHub CI/CD с автоматическим созданием тега и релиза
on:
  push:
    branches:
      - main  # Запускать workflow при пуше в ветку main

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Клонирование репозитория
        uses: actions/checkout@v3  # Используем v3 для GitHub

      - name: Установка JDK
        uses: actions/setup-java@v3  # Используем v3 для GitHub
        with:
          java-version: "21"
          distribution: 'temurin'

      - name: Сборка проекта
        run: ./gradlew build

      - name: Проверка выходных файлов
        run: ls -la build/libs

      - name: Автоматическое создание тега
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: create_tag
        run: |
          echo "Создание тега..."
          TAG_NAME="v$(date +%Y.%m.%d)-${GITHUB_RUN_NUMBER}"
          echo "tag_name=${TAG_NAME}" >> $GITHUB_ENV
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag ${TAG_NAME}
          # Используем личный токен для аутентификации
          git push https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/${{ github.repository }}.git ${TAG_NAME}

      - name: Создание релиза и загрузка JAR-файла
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1  # Используем действие для создания релиза
        with:
          files: build/libs/*.jar  # Загружаем JAR-файл напрямую
          body: "Автоматически созданный релиз из GitHub Actions"
          token: ${{ secrets.GITHUB_TOKEN }}  # Токен для авторизации
